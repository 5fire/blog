traceroute程序理解
==================================

IP记录路由选项(RR)可以记录路由路径. 比如在我们ping一个主机的时候就可以带上这个选项. 那么traceroute存在的理由又是什么呢?

1. 首先, 原先并不是所有的路由器都支持记录路由选项, 因此该选项在某些路径上不能使用.
2. 记录路由一般是单向的选项.发送端设置了该选项, 那么接收端不得不从收到的IP首部中提取所有的信息, 然后全部返回给发送端.
3. 最后一个, 也是最主要的理由:IP首部留给选项的空间有限, 事实上只有9个以内的地址可以记录.

基于上面三点理由, traceroute有着充分的理由.
traceroute程序使用icmp报文(icmp报文通过ip传输)和IP首部中的TTL字段.TTL字段的目的是为了防止数据报在选路时无休止地在网络中流动.当路由收到一份IP数据报, 如果TTL字段为0或1, 那么就不能转发, 应该丢弃, 并给源主机发送一份icmp超时的数据报. traceroute程序的关键在于包含这份icmp信息的ip报文的信源地址是该路由器的ip地址.
traceroute程序发送一份udp数据报给目的主机, 但是选择一个不可能的值作为udp端口号, 使目的主机的任何一个应用程序都不可能使用该端口. 所以, 当该数据报到达的时候, 目的主机的udp模块将产上一个端口不可到达的错误的icmp报文. 这样, traceroute程序只要区分接收到的icmp报文是超时还是端口不可达, 以判断什么时候结束.

traceroute发送的udp报文, 封装在ip数据报中, 并将ttl值不断增大. 因为ttl减少为1而被丢弃的icmp超时报文, 和最后到达目的主机, 端口不可达的icmp错误报文.

traceroute程序接收到icmp报文时候, 获得的唯一信息就是产生该错误报文的主机的ip地址. 那么traceroute怎么计算往返时间. traceroute计算往返时间和ping程序不同. ping程序会将发出报文时候的时间戳记录到报文中. 然后等到接收到应答报文的时候, 提取当前时间, 两个值相减.
traceroute并不会将时间戳放在报文中. 而是程序自己记录时间, 等到报文回来, 再减去得到时间.