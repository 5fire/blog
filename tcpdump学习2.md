tcpdump命令书写
============================

tcpdump通过设置网络接口为混杂模式来截获通过网卡的数据包.tcpdump有很多的选项, 比如选用接口的'-i', 
选用协议的'-p', 显示数据帧首部'-e',有很多的功能. 这个可以通过我们的man手册查询得到, 想要真正的
熟练运用tcpdump, 必须熟悉tcp/ip协议. 因为tcpdump仅仅是抓取包的工具,真正的内涵是要我们系统学习了
协议知识才能理解.

tcpdump命令书写
-----------------------------------

tcpdump命令书写仅仅有两种元素

1.  选项

    这个就比如刚刚提到的'-i', '-e', '-p', 这个很简单, 需要的时候你就用man手册查一下.
    比如, 我们抓取了tcp数据报文段的时候, 想要把序号显示为绝对序号, 那么就设置为'-S'.
    我们想要详细的ip地址, 而不是主机名称, 那么就可以设置'-n'

2.  表达式(expression)
    
    表达式可以让我们设置更为复杂的筛选条件.表达式由原语组成, 这里原语可以使用逻辑符号组成更为复杂的表达式.
    原语由修饰符和标志符组成.修饰符号有三种:

    1. 类型: host, net, port, 默认为host
    2. 方向: src, dst, 默认为 src or dst
    3. 协议: ether, fddi, ip, arp, rarp, decnet, lat, sca, moprc, mopdl, tcp, udp, 默认为所有协议

    > 显示 所有 通过 网关 snup 的 ftp 报文 (注意 这个 表达式 被 单引号 括起, 防止 shell 解释 园括弧):
    >`tcpdump 'gateway snup and (port ftp or ftp-data)`

举例:

1.  抓取端口为80, 带有数据的tcp数据报文段, 而不是SYN, FIN, ACK, 等数据报文段.
    
    `tcpdump tcp port 80 and ((ip[2:2] - ((ip[0] & 0xf) << 2) - ((tcp[12] & 0xf0) >> 2)) != 0)`

    这里我们解释一下为什么会怎么写, 首先前面的'tcp port 80'这一部分是很简单的表达式, tcp是协议修饰符, port是类型修饰,
    80是标志符. 这是一个原语. 然后大的表达式是由and将两个小的原语连接而成.

    因为ip数据报第三个字节(字节序号为2, 从零开始计数)是记录整个数据包长度的, 总个两个字节-16比特. 所以表示出来就是:
    ip[2:2], 这里表示整个ip数据报的长度.

    ((ip[0] & 0xf) << 2), 这个表达式得出ip数据报首部长度大小. ip数据报第一个字节后4位是记录ip首部长度大小的. 单位是32bit, 也就是说最长是15*4=60个字节.
    我们知道ip固定首部的长度是20个字节, 其他的浮动在于选项首部. 比如路由选项. 首先取到第一个字节的后四位 'ip[0] & 0xf', 然后再乘以4,
    也就是左移2bit.

    ((tcp[12] & 0xf0) >> 2), 同样这个是计算tcp数据报文段首部长度大小. tcp报文段的第13个字节前4位记录首部长度, 我们先
    取出这四位, 也就是'(tcp[12] & 0xf0) >> 4' ,然后再乘以4, 也就是左移2位, '(((tcp[12] & 0xf0) >> 4) << 2)'. 
    这样就相当与'((tcp[12] & 0xf0) >> 2)'.

2.  抓取icmp请求回显, 回显应答的报文, 也就是ping报文.

    icmp是网络层的协议, 通过ip数据报来传输. 第一个字节是类型, 请求回显, 回显应答 的类型值分别是8, 0.

    `tcpdump icmp[0] = 8 or icmp[0] = 0`