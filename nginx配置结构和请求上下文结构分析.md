nginx配置结构
==========


nginx请求上下文结构
==========

nginx有一类结构——上下文， 现在我们要讲的就是关于请求的上下文。nginx一定是需要上下文这个结构的，为什么？因为nginx是一个全异步的处理方式，

所以我们一定要有一个特定的结构来告诉每一个阶段处理的模块，这个请求现在被处理的情况。就像我们去火锅店吃饭一样，我们自己会保留一张单子，这张单子记录着

我们点的菜，已经上了哪些菜，还有哪些没有上，为什么要记录这些？因为火锅店的服务员不会为每一桌都专门配置一个。而是异步服务的方式，哪里有需要服务器，就

服务哪里。

**http框架定义的上下文是针对与http请求的，而且每一个http请求对应于每一个模块都可以有一个独立的上下文结构体（并不是一个请求的上下文结构由所有的http模块共用）**

上下文是什么？
----------

在一个请求的处理过程，用类似struct这样的结构体把一些关键信息保存下来， 这个结构体就叫做上下文结构.

每一个http模块都可以有自己的上下文结构，一般都是在刚开始处理请求时， 在内存上分配它， 之后当经由epoll，http框架再次调用到http模块的处理方法时，

这个http模块可以由请求的上下文结构体中获取信息。请求结束后，销毁该请求的内存池，自然就销毁了上下文结构。

**一个上下文结构体是仅对1个请求1个模块而言的，所以是低耦合的**

nginx的上下文的概念很重要，原因是nginx是一个强大的全异步处理的web服务器， 一个http请求不会在一个epoll调度中就完成， 有可能非常多的处理调度。

nginx定义了两个宏来处理上下文
----------

1. `#define ngx_http_get_module_ctx(r, module) (r)->ctx[module.ctx_index]`

2. `#define ngx_http_set_ctx(r, c, module) r->ctx[module.ctx_index] = c`

在我们的`ngx_http_request_s`结构中，有如下定义：

```
struct ngx_http_request_s {
	...
	void **ctx;
	...
}
```

这里的ctx就是存储我们每一个处理模块上下文结构的指针.
